openapi: 3.0.3
info:
  title: HRMS Backend API
  version: 1.0.0
servers:
  - url: http://localhost:5002
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiSuccess"
              example:
                ok: true
                data:
                  status: ok
  /api:
    post:
      summary: Action dispatcher (GAS doPost compatible)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApiRequest"
      responses:
        "200":
          description: Success or error (always JSON)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /api/employees/{employeeId}/profile:
    get:
      summary: Employee profile (employee + docs + role history + exit case)
      security:
        - SessionToken: []
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/employees/{employeeId}/docs:
    get:
      summary: Employee document list
      security:
        - SessionToken: []
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/employees/{employeeId}/role-change:
    post:
      summary: Change employee role (creates role history + updates currentRole)
      security:
        - SessionToken: []
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [newRole]
              properties:
                newRole:
                  type: string
                effectiveAt:
                  type: string
                  description: ISO timestamp; defaults to now
                remark:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/employees/check-duplicate:
    post:
      summary: Check Aadhaar+DOB uniqueness (does not store full Aadhaar)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [aadhaar, dob]
              properties:
                aadhaar:
                  type: string
                dob:
                  type: string
                  description: YYYY-MM-DD
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/docs/upload:
    post:
      summary: Upload employee document (multipart)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [employeeId, docType, file]
              properties:
                employeeId:
                  type: string
                docType:
                  type: string
                visibility:
                  type: string
                  enum: [INTERNAL, EMPLOYEE]
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/docs/download/{docId}:
    get:
      summary: Secure download employee document
      description: Streams local files; in FILE_STORAGE_MODE=gas, redirects to Drive after permission check.
      security:
        - SessionToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: File bytes (or redirect)
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "403":
          description: Forbidden (JSON error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /api/exit/start-notice:
    post:
      summary: Start self-exit notice period
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [employeeId]
              properties:
                employeeId:
                  type: string
                noticeDays:
                  type: integer
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/exit/mark-absconded:
    post:
      summary: Mark employee as absconded (creates exit case)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [employeeId, absentSince]
              properties:
                employeeId:
                  type: string
                absentSince:
                  type: string
                  description: Date/time
                remark:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/exit/terminate-init:
    post:
      summary: Start termination workflow (creates exit case)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [employeeId, lastWorkingDay]
              properties:
                employeeId:
                  type: string
                lastWorkingDay:
                  type: string
                  description: Date/time
                remark:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/exit/settlement-clear:
    post:
      summary: Mark settlement cleared (requires settlement document)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [exitId, settlementDocId]
              properties:
                exitId:
                  type: string
                settlementDocId:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/exit/attach-termination-letter:
    post:
      summary: Attach termination letter (terminated exits only)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [exitId, terminationLetterDocId]
              properties:
                exitId:
                  type: string
                terminationLetterDocId:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/exit/complete:
    post:
      summary: Complete exit (server-enforced rules)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [exitId]
              properties:
                exitId:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/modules:
    get:
      summary: List training modules + settings + question counts
      security:
        - SessionToken: []
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/admin/questions/{moduleId}:
    get:
      summary: Get training test settings + questions (admin)
      security:
        - SessionToken: []
      parameters:
        - name: moduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/admin/save-questions:
    post:
      summary: Save training test settings + questions (admin)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [moduleId, settings, questions]
              properties:
                moduleId:
                  type: string
                settings:
                  type: object
                questions:
                  type: array
                  items:
                    type: object
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/start-test:
    post:
      summary: Start a training test attempt
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [moduleId, employeeId]
              properties:
                moduleId:
                  type: string
                employeeId:
                  type: string
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/submit-test:
    post:
      summary: Submit a training test (server evaluates score)
      security:
        - SessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [moduleId, employeeId, attemptNo, answers]
              properties:
                moduleId:
                  type: string
                employeeId:
                  type: string
                attemptNo:
                  type: integer
                answers:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: OK (or JSON error)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiSuccess"
                  - $ref: "#/components/schemas/ApiError"
  /api/training/video/stream/{moduleId}:
    get:
      summary: Stream training video (proxy; best-effort URL hiding)
      security:
        - SessionToken: []
      parameters:
        - name: moduleId
          in: path
          required: true
          schema:
            type: string
        - name: index
          in: query
          required: false
          schema:
            type: integer
        - name: token
          in: query
          required: false
          schema:
            type: string
          description: Alternative auth (same as session token)
      responses:
        "200":
          description: Video bytes (proxied)
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
components:
  securitySchemes:
    SessionToken:
      type: http
      scheme: bearer
      bearerFormat: ST-...
  schemas:
    ApiRequest:
      type: object
      required: [action]
      properties:
        action:
          type: string
          enum:
            - ADMIN_EXCEL_MARKS_SUBMIT
            - AUTO_REJECT_FINAL_NOSHOW
            - AUTO_REJECT_INPERSON_LOW
            - AUTO_REJECT_NOTPICK
            - CANDIDATE_ADD
            - CANDIDATE_BULK_ADD
            - COPY_TEMPLATE_DATA
            - DOCS_COMPLETE
            - DOCS_UPLOAD
            - EA_TECH_MARKS_SUBMIT
            - EMPLOYEE_CREATE_FROM_CANDIDATE
            - EMPLOYEE_GET
            - EMPLOYEE_PROFILE_GET
            - EMPLOYEE_DOCS_LIST
            - EMPLOYEE_ROLE_CHANGE
            - EMPLOYEE_DUPLICATE_CHECK
            - EMPLOYEE_LOGIN
            - FILE_UPLOAD_CV
            - FINAL_INTERVIEW_LIST
            - FINAL_SEND_OWNER
            - GET_ME
            - HOLD_EXPIRY_CRON
            - HOLD_REVERT
            - HR_FINAL_HOLD_LIST
            - HR_HOLD_SCHEDULE
            - HR_REQUIREMENTS_LIST
            - HR_WALKIN_SCHEDULE
            - INPERSON_MARKS_SAVE
            - INPERSON_PIPELINE_LIST
            - JOBPOST_COMPLETE
            - JOBPOST_INIT
            - JOBPOST_MARK_PORTAL
            - JOBPOST_SET_PORTALS
            - JOBPOST_UPLOAD_SCREENSHOT
            - JOINING_LIST
            - JOINING_SET_DATE
            - LOGIN_EXCHANGE
            - LOGS_QUERY
            - MARK_JOIN
            - MY_PERMISSIONS_GET
            - OWNER_CANDIDATES_LIST
            - OWNER_DECIDE
            - OWNER_FINAL_DECIDE
            - PASSFAIL_EVALUATE
            - PERMISSIONS_LIST
            - PERMISSIONS_UPSERT
            - PRECALL_LIST
            - PRECALL_UPDATE
            - PREINTERVIEW_MARKS_SAVE
            - PREINTERVIEW_STATUS
            - PROBATION_DECIDE
            - PROBATION_LIST
            - PROBATION_SET
            - REJECT_REVERT
            - REJECTION_LOG_LIST
            - REQUIREMENT_APPROVE
            - REQUIREMENT_AUTO_CLOSE
            - REQUIREMENT_CLARIFICATION
            - REQUIREMENT_CREATE
            - REQUIREMENT_GET
            - REQUIREMENT_LIST_BY_ROLE
            - REQUIREMENT_RESUBMIT
            - REQUIREMENT_SUBMIT
            - REQUIREMENT_UPDATE
            - ROLE_CHANGE
            - ROLES_LIST
            - ROLES_UPSERT
            - SESSION_VALIDATE
            - SETTINGS_GET
            - SETTINGS_UPSERT
            - SHORTLIST_DECIDE
            - SHORTLIST_HOLD_REVERT
            - TECH_PENDING_LIST
            - TECH_SELECT
            - TEMPLATE_LIST
            - TEMPLATE_UPSERT
            - TEST_FAIL_DECIDE
            - TEST_LINK_CREATE
            - TEST_QUESTIONS_GET
            - TEST_RESULT_GET
            - TEST_SUBMIT_PUBLIC
            - TEST_TOKEN_VALIDATE
            - TRAINING_ASSIGN
            - TRAINING_DASHBOARD
            - TRAINING_LIST
            - TRAINING_MASTER_LIST
            - TRAINING_MASTER_UPSERT
            - TRAINING_MODULES_GET
            - TRAINING_ADMIN_GET_QUESTIONS
            - TRAINING_ADMIN_SAVE_QUESTIONS
            - TRAINING_START_TEST
            - TRAINING_SUBMIT_TEST
            - TRAINING_STATUS_UPDATE
            - TRAINING_SUMMARY
            - USERS_LIST
            - USERS_UPSERT
            - WALKIN_SCHEDULE
            - EXIT_START_NOTICE
            - EXIT_MARK_ABSCONDED
            - EXIT_TERMINATE_INIT
            - EXIT_SETTLEMENT_CLEAR
            - EXIT_ATTACH_TERMINATION_LETTER
            - EXIT_COMPLETE
        token:
          type: string
          description: Session token (ST-...) for protected actions; omitted for public actions.
        data:
          type: object
          additionalProperties: true
          description: Action-specific payload.
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [BAD_REQUEST, AUTH_INVALID, FORBIDDEN, NOT_FOUND, CONFLICT, INTERNAL]
        message:
          type: string
    ApiSuccess:
      type: object
      required: [ok, data]
      properties:
        ok:
          type: boolean
          enum: [true]
        data:
          description: Action result (opaque; matches GAS behavior)
    ApiError:
      type: object
      required: [ok, error]
      properties:
        ok:
          type: boolean
          enum: [false]
        error:
          $ref: "#/components/schemas/Error"
