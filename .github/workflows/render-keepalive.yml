name: Render Keepalive (Free Tier)

on:
  schedule:
    # Every 5 minutes (minimum practical interval for GitHub scheduled workflows).
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Ping /health
        env:
          HEALTH_URL: ${{ secrets.RENDER_HEALTH_URL }}
          STRICT_KEEPALIVE: ${{ secrets.STRICT_KEEPALIVE }}
        run: |
          set -euo pipefail

          if [ -z "${HEALTH_URL:-}" ]; then
            echo "Missing secrets.RENDER_HEALTH_URL (example: https://<service>.onrender.com/health)"
            exit 1
          fi

          echo "Pinging: ${HEALTH_URL}"
          if curl -fsS --max-time 20 --retry 3 --retry-all-errors "${HEALTH_URL}" > /tmp/health.json; then
            echo "OK"
            head -c 800 /tmp/health.json || true
            echo
            exit 0
          fi

          echo "Ping failed."
          if [ "${STRICT_KEEPALIVE:-0}" = "1" ]; then
            exit 1
          fi
          exit 0

